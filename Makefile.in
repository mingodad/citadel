# $Id$

AUTOCONF=@AUTOCONF@
CC=@CC@
CFLAGS=@CFLAGS@
DEFS=@DEFS@
INSTALL=@INSTALL@
LIBOBJS=@LIBOBJS@
LIBS=@LIBS@
LDFLAGS=@LDFLAGS@
SED=@SED@
SETUP_LIBS=@SETUP_LIBS@
PTHREAD_DEFS=@PTHREAD_DEFS@
srcdir=@srcdir@
prefix=@prefix@
top_builddir=`pwd`

LIB_SUBDIRS=
PROG_SUBDIRS=po
SUBDIRS=$(LIB_SUBDIRS) $(PROG_SUBDIRS) 

# End of configuration section

all: all-progs-recursive webserver setup


.SUFFIXES: .c .o

clean:
	rm -f *.o webcit webserver

distclean: clean
	rm -f Makefile config.cache config.log config.status\
		$(srcdir)/TAGS

setup: setup.o tools.o
	$(CC) setup.o tools.o \
	$(LIBOBJS) $(LIBS) $(LDFLAGS) $(SETUP_LIBS) -o setup

webserver: webserver.o context_loop.o tools.o ical_dezonify.o \
	cookie_conversion.o locate_host.o floors.o summary.o \
	webcit.o auth.o tcp_sockets.o mainmenu.o serv_func.o who.o \
	roomops.o messages.o userlist.o paging.o sysmsgs.o useredit.o \
	vcard.o vcard_edit.o preferences.o html2html.o listsub.o \
	mime_parser.o graphics.o netconf.o siteconfig.o subst.o rss.o \
	calendar.o calendar_tools.o calendar_view.o event.o \
	availability.o iconbar.o crypto.o inetconf.o notes.o \
	groupdav_main.o groupdav_get.o groupdav_propfind.o fmt_date.o \
	groupdav_options.o autocompletion.o \
	groupdav_delete.o groupdav_put.o http_datestring.o setup_wizard.o \
	$(LIBOBJS)
	$(CC) webserver.o context_loop.o tools.o cookie_conversion.o \
	webcit.o auth.o tcp_sockets.o mainmenu.o serv_func.o who.o listsub.o \
	roomops.o messages.o userlist.o paging.o sysmsgs.o useredit.o \
	locate_host.o siteconfig.o subst.o vcard.o vcard_edit.o floors.o \
	mime_parser.o graphics.o netconf.o preferences.o html2html.o rss.o \
	summary.o calendar.o calendar_tools.o calendar_view.o event.o \
	availability.o ical_dezonify.o iconbar.o crypto.o inetconf.o notes.o \
	groupdav_main.o groupdav_get.o groupdav_propfind.o groupdav_delete.o \
	groupdav_options.o autocompletion.o \
	groupdav_put.o http_datestring.o setup_wizard.o fmt_date.o \
	$(LIBOBJS) $(LIBS) $(LDFLAGS) -o webserver

.c.o:
	$(CC) $(CFLAGS) $(DEFS) -c $(PTHREAD_DEFS) -DWEBCITDIR=\"$(prefix)\" -DLOCALEDIR=\"$(prefix)/locale\" $<

Makefile: $(srcdir)/Makefile.in config.status
	CONFIG_FILES="Makefile" CONFIG_HEADERS= $(SHELL) ./config.status

config.status: $(srcdir)/configure
	$(SHELL) ./config.status --recheck

$(srcdir)/configure: $(srcdir)/configure.in $(srcdir)/aclocal.m4
	cd $(srcdir) && $(AUTOCONF)

install:
	test -d $(root)$(prefix) || mkdir $(root)$(prefix)
	test -d $(root)$(prefix)/static || mkdir $(root)$(prefix)/static
	for i in `find tiny_mce -type d | grep -v .svn` \
		; do \
		test -d $(root)$(prefix)/$$i || mkdir $(root)$(prefix)/$$i; \
	done
	for i in \
		webserver \
		setup \
		`find static -type f | grep -v .svn` \
		`find tiny_mce -type f | grep -v .svn` \
		; do \
		$(INSTALL) $$i $(root)$(prefix)/$$i; \
	done

TAGS clean-recursive distclean-recursive depend-recursive check-recursive \
  mostlyclean-recursive realclean-recursive:
	@for subdir in $(SUBDIRS); do \
	  if test -d $$subdir ; then \
	    target=`echo $@|$(SED) 's/-recursive//'`; \
	    echo making $$target in $$subdir; \
	    (cd $$subdir && $(MAKE) $$target) || exit 1; \
	  fi ; \
	done

all-progs-recursive install-progs-recursive install-strip-progs-recursive \
  uninstall-progs-recursive:
	@for subdir in $(PROG_SUBDIRS); do \
	  if test -d $$subdir ; then \
	    target=`echo $@|$(SED) 's/-progs-recursive//'`; \
	    echo making $$target in $$subdir; \
	    (cd $$subdir && $(MAKE) $$target) || exit 1; \
	  fi ; \
	done

all-libs-recursive install-libs-recursive install-strip-libs-recursive \
  uninstall-libs-recursive install-shlibs-libs-recursive \
  install-shlibs-strip-libs-recursive uninstall-shlibs-libs-recursive:
	@for subdir in $(LIB_SUBDIRS); do \
	  if test -d $$subdir ; then \
	    target=`echo $@|$(SED) 's/-libs-recursive//'`; \
	    echo making $$target in $$subdir; \
	    (cd $$subdir && $(MAKE) $$target) || exit 1; \
	  fi ; \
	done

